# 学习进度（Action-Sequence）

- 日期：2025-11-02
- 本轮目标：从“AI 协作学习”规则出发，完成第 1 课：帧时钟（时间源/节拍/追帧/丢帧策略）

## 关键进展
- 文档：`ai协作学习.md` → 重命名并规范为 `AI协作学习.md`；仅保留文档，清空历史脚本（学习目的）。
- 学习实现：新增教学用 `Core/ActionFrameClock.cs` 与 `Core/ActionFrameClock2.cs`（练习版）。
- 问题排查：修复整数除法、循环自增、无条件清零余量、错误丢弃条件等典型陷阱。

## 帧时钟要点（本轮共识）
- 角色：仅负责“稳定节拍与时间度量”，不掺杂业务。
- 步进：`ExpectationStep = 1f / 60f`（≈0.0166667），必须用浮点防止整除变 0。
- 追帧：`while (accumulateTime >= step && perFrame < max)`，每次循环：减步进、计数自增、触发 Tick。
- 丢帧：仅当“已达本帧追帧上限 且 积压时间 > 阈值”才丢弃（清零 `accumulateTime`）。
- 观测：每 60 次输出 expected/actual/lag/backlog；避免每帧日志造成新的抖动。

## 当前实现参数（建议）
- `ExpectationFrame = 60`
- `ExpectationStep  = 1f / ExpectationFrame`
- `MaxPerFrameCount = 3 ~ 4`
- `MaxBacklogSeconds = 0.25 ~ 0.5`

## 常见陷阱与修复
- 整数除法：`1/60==0` → 必须写 `1f/60`。
- 自增位置：不要在 while 条件里 `accumulatePreFrame++`，放到循环体内，行为直观可控。
- 无条件清零：循环后不要直接 `accumulateTime=0`，除非到达上限且积压超阈值。
- 错误判定：丢弃条件要看 `accumulateTime`（积压时长），不是累计运行时长。
- 事件范围：`static event` 易遗留订阅；订阅端务必成对订/退（后续课程会给规范）。

## 指标采样（本轮日志节选）
- 参数：`MaxPerFrameCount=4`、`MaxBacklogSeconds≈0.25`
- 运行日志（每 60 Tick 打印一次）：
```text
expected=137, actual=120, lag=17, backlog=0.0102
expected=196, actual=180, lag=16, backlog=0.0096
expected=256, actual=240, lag=16, backlog=0.0094
expected=316, actual=300, lag=16, backlog=0.0092
```
- 解读：`lag≈16`（历史欠账），`backlog<step`，系统稳定；不建议将丢弃条件改为 `||`，保留 `&&` 更合理。

## 最小可验证里程碑（MVM）
- 提供 `OnTick` 事件；每帧推进并在低帧率下受限追帧。
- `accumulateTime` 只在“达到上限 且 积压>阈值”时清零；否则保留余量。
- 每 60 次输出统计（expected/actual/lag/backlog）。

## 快速验收标准
- 连续 10 秒：累计 Tick ≈ 600（±10%），`lag` 不持续扩大。
- `Application.targetFrameRate=30` 时，无卡死；单帧追帧 ≤ `MaxPerFrameCount`。
- 多数时刻 `backlog < 0.0167`。

## 明日学习计划（建议）
- 默写：不看代码手写一遍 `ActionFrameClock`（或 `ActionFrameClock2`），跑 10 秒统计并对比。
- 增强：加入 `Pause()/Resume()` 与 `IsPaused`，保持接口极简。
- 观测：将统计封装为可选调试输出（避免每帧日志）。
- 预告：第 2 课准备“动作数据模型（ActionClip/Sequence）”。

## 变更记录（Changelog）
- 2025-11-02：文档重命名与规范；清空历史脚本；新增时钟教学实现；修复若干陷阱；建立统计与验收标准。


